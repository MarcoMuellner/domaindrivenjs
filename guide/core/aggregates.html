<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.21" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="/images/logo.png"><meta name="theme-color" content="#3498db"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><title>Working with Aggregates | DomainDrivenJS</title><meta name="description" content="A modern, composition-based Domain-Driven Design library for JavaScript">
    <link rel="preload" href="/domaindrivenjs/assets/style-Cyw_glhd.css" as="style"><link rel="stylesheet" href="/domaindrivenjs/assets/style-Cyw_glhd.css">
    <link rel="modulepreload" href="/domaindrivenjs/assets/app-BR1hGEJk.js"><link rel="modulepreload" href="/domaindrivenjs/assets/aggregates.html-B2p3KypV.js">
    <link rel="prefetch" href="/domaindrivenjs/assets/index.html-DhPSV7nj.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/aggregates.html-BPrxrWM-.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/domain-events.html-B3j6hfF4.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/domain-services.html-D7mQ_a3w.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/entities.html-B8LJXDoa.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/index.html-CkVCpIVn.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/repositories.html-q9z942hT.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/specifications.html-BCIH8Ggv.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/value-objects.html-CF2hRjg7.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/banking.html-C0RyjU4w.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/e-commerce.html-DD4LeiLR.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/index.html-D6KTFzAL.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/task-management.html-DUbGZbkW.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/getting-started.html-CgaEZYAr.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/quick-start.html-Dy1hpEd6.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/antipatterns.html-BgFLFBD0.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/best-practices.html-BzUjGVFh.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/extending-components.html-DshhxGlQ.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/testing.html-Ckx2Il5j.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/domain-events.html-CLi6DN4x.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/domain-services.html-DBXRfU80.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/entities.html-Z50GiB8w.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/index.html-Dw7HOnBk.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/repositories.html-DvWX5yBq.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/specifications.html--iOlVgDD.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/value-objects.html-BhVTGfBS.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/index.html-J9xlNChJ.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/strategic-design.html-ywg5dx65.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/tactical-design.html-BZsqD42e.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/ubiquitous-language.html-C5XeXrbj.js" as="script"><link rel="prefetch" href="/domaindrivenjs/assets/404.html-D1xDrHvZ.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/domaindrivenjs/"><img class="vp-site-logo" src="/domaindrivenjs/images/logo.png" alt="DomainDrivenJS"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">DomainDrivenJS</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/domaindrivenjs/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Guide"><span class="title">Guide</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Guide"><span class="title">Guide</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/domaindrivenjs/guide/getting-started.html" aria-label="Getting Started"><!--[--><!--[--><!--]--><!--]-->Getting Started<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/domaindrivenjs/guide/quick-start.html" aria-label="Quick Start"><!--[--><!--[--><!--]--><!--]-->Quick Start<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/domaindrivenjs/guide/ddd/" aria-label="DDD Fundamentals"><!--[--><!--[--><!--]--><!--]-->DDD Fundamentals<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/domaindrivenjs/guide/core/" aria-label="Core Concepts"><!--[--><!--[--><!--]--><!--]-->Core Concepts<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/domaindrivenjs/guide/advanced/" aria-label="Advanced Topics"><!--[--><!--[--><!--]--><!--]-->Advanced Topics<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/domaindrivenjs/api/" aria-label="API"><!--[--><!--[--><!--]--><!--]-->API<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/domaindrivenjs/examples/" aria-label="Examples"><!--[--><!--[--><!--]--><!--]-->Examples<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/MarcoMuellner/DomainDrivenJS" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" placeholder="Search documentation" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/domaindrivenjs/" aria-label="Home"><!--[--><!--[--><!--]--><!--]-->Home<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="Guide"><span class="title">Guide</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="Guide"><span class="title">Guide</span><span class="right arrow"></span></button><ul class="vp-navbar-dropdown" style="display:none;"><!--[--><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/domaindrivenjs/guide/getting-started.html" aria-label="Getting Started"><!--[--><!--[--><!--]--><!--]-->Getting Started<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/domaindrivenjs/guide/quick-start.html" aria-label="Quick Start"><!--[--><!--[--><!--]--><!--]-->Quick Start<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/domaindrivenjs/guide/ddd/" aria-label="DDD Fundamentals"><!--[--><!--[--><!--]--><!--]-->DDD Fundamentals<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link route-link-active auto-link" href="/domaindrivenjs/guide/core/" aria-label="Core Concepts"><!--[--><!--[--><!--]--><!--]-->Core Concepts<!--[--><!--[--><!--]--><!--]--></a></li><li class="vp-navbar-dropdown-item"><a class="route-link auto-link" href="/domaindrivenjs/guide/advanced/" aria-label="Advanced Topics"><!--[--><!--[--><!--]--><!--]-->Advanced Topics<!--[--><!--[--><!--]--><!--]--></a></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/domaindrivenjs/api/" aria-label="API"><!--[--><!--[--><!--]--><!--]-->API<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/domaindrivenjs/examples/" aria-label="Examples"><!--[--><!--[--><!--]--><!--]-->Examples<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/MarcoMuellner/DomainDrivenJS" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><!--]--><!--]-->GitHub<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">Introduction <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/getting-started.html" aria-label="Getting Started with DomainDrivenJS"><!--[--><!--[--><!--]--><!--]-->Getting Started with DomainDrivenJS<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/quick-start.html" aria-label="Quick Start Guide"><!--[--><!--[--><!--]--><!--]-->Quick Start Guide<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">DDD Fundamentals <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/ddd/" aria-label="Introduction to Domain-Driven Design"><!--[--><!--[--><!--]--><!--]-->Introduction to Domain-Driven Design<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/ddd/strategic-design.html" aria-label="Strategic Design in Domain-Driven Design"><!--[--><!--[--><!--]--><!--]-->Strategic Design in Domain-Driven Design<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/ddd/tactical-design.html" aria-label="Tactical Design in Domain-Driven Design"><!--[--><!--[--><!--]--><!--]-->Tactical Design in Domain-Driven Design<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/ddd/ubiquitous-language.html" aria-label="Ubiquitous Language"><!--[--><!--[--><!--]--><!--]-->Ubiquitous Language<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active">Core Concepts <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/core/value-objects.html" aria-label="Understanding Value Objects"><!--[--><!--[--><!--]--><!--]-->Understanding Value Objects<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/core/entities.html" aria-label="Working with Entities"><!--[--><!--[--><!--]--><!--]-->Working with Entities<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/domaindrivenjs/guide/core/aggregates.html" aria-label="Working with Aggregates"><!--[--><!--[--><!--]--><!--]-->Working with Aggregates<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/core/repositories.html" aria-label="Working with Repositories"><!--[--><!--[--><!--]--><!--]-->Working with Repositories<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/core/domain-events.html" aria-label="Working with Domain Events"><!--[--><!--[--><!--]--><!--]-->Working with Domain Events<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/core/specifications.html" aria-label="Working with Specifications"><!--[--><!--[--><!--]--><!--]-->Working with Specifications<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/core/domain-services.html" aria-label="Working with Domain Services"><!--[--><!--[--><!--]--><!--]-->Working with Domain Services<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">Advanced Topics <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/advanced/extending-components.html" aria-label="Extending DomainDrivenJS Components"><!--[--><!--[--><!--]--><!--]-->Extending DomainDrivenJS Components<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/advanced/testing.html" aria-label="Testing Domain-Driven Design Applications"><!--[--><!--[--><!--]--><!--]-->Testing Domain-Driven Design Applications<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/advanced/best-practices.html" aria-label="Domain-Driven Design Best Practices"><!--[--><!--[--><!--]--><!--]-->Domain-Driven Design Best Practices<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/domaindrivenjs/guide/advanced/antipatterns.html" aria-label="Domain-Driven Design Anti-Patterns"><!--[--><!--[--><!--]--><!--]-->Domain-Driven Design Anti-Patterns<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="working-with-aggregates" tabindex="-1"><a class="header-anchor" href="#working-with-aggregates"><span>Working with Aggregates</span></a></h1><p>Aggregates are a crucial pattern in Domain-Driven Design that solve one of the most challenging problems in software: <strong>maintaining consistency in a complex object graph</strong>. They provide clear boundaries for transactional changes and help you design models that protect business rules.</p><h2 id="what-is-an-aggregate" tabindex="-1"><a class="header-anchor" href="#what-is-an-aggregate"><span>What is an Aggregate?</span></a></h2><p>An aggregate is a cluster of domain objects (entities and value objects) treated as a single unit for data changes. Each aggregate has:</p><ul><li><strong>Root Entity</strong> - A single entry point that controls access to members inside the aggregate</li><li><strong>Boundary</strong> - A clear demarcation of what&#39;s inside vs. outside the aggregate</li><li><strong>Invariants</strong> - Business rules that must be consistent within the aggregate</li><li><strong>Identity</strong> - Derived from the root entity&#39;s identity</li><li><strong>Transactional Consistency</strong> - All changes to objects inside the boundary happen in a single transaction</li></ul><h3 id="visualizing-an-aggregate" tabindex="-1"><a class="header-anchor" href="#visualizing-an-aggregate"><span>Visualizing an Aggregate</span></a></h3><p>Think of an aggregate like a protective bubble around a group of related objects:</p><ul><li>The <strong>aggregate root</strong> is the only entity visible from outside</li><li>External objects can only reference the root, not the internal members</li><li>All modifications must go through the root, which enforces invariants</li><li>When saved, everything inside the bubble is saved together</li></ul><h2 id="why-use-aggregates" tabindex="-1"><a class="header-anchor" href="#why-use-aggregates"><span>Why Use Aggregates?</span></a></h2><p>Aggregates solve several critical problems in domain modeling:</p><ol><li><strong>Consistency Enforcement</strong> - Maintain business rules across related objects</li><li><strong>Simplified Object Graphs</strong> - Prevent tangled webs of object references</li><li><strong>Clear Transaction Boundaries</strong> - Define what must be changed together</li><li><strong>Reduced Complexity</strong> - Protect the internal state of object clusters</li><li><strong>Controlled Access</strong> - Provide a single point of entry for modifications</li><li><strong>Decoupled Design</strong> - Limit dependencies between different parts of the system</li></ol><h3 id="the-problem-aggregates-solve" tabindex="-1"><a class="header-anchor" href="#the-problem-aggregates-solve"><span>The Problem Aggregates Solve</span></a></h3><p>Without aggregates, object relationships become tangled and consistency becomes difficult to maintain:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">// WITHOUT AGGREGATES: Complex, tangled object relationships</span>
<span class="line">order.customer.address.changeCity(&quot;New York&quot;);</span>
<span class="line">order.items[0].product.decreaseStock(2);</span>
<span class="line">order.updateTotal();</span>
<span class="line">// Did we remember to update everything that depends on these changes?</span>
<span class="line">// What if an invariant is violated?</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>With aggregates, we have clear boundaries and access rules:</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code><span class="line">// WITH AGGREGATES: Clean, controlled modifications</span>
<span class="line">order.shipTo(newAddress); // Order aggregate handles internal consistency</span>
<span class="line">inventory.decreaseStock(productId, 2); // Inventory aggregate handles stock rules</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="creating-aggregates-with-domaindrivenjs" tabindex="-1"><a class="header-anchor" href="#creating-aggregates-with-domaindrivenjs"><span>Creating Aggregates with DomainDrivenJS</span></a></h2><p>DomainDrivenJS makes creating aggregates straightforward with the <code>aggregate</code> factory function:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> z <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;zod&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> aggregate<span class="token punctuation">,</span> valueObject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;domaindrivenjs&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Define a value object for use within the aggregate</span></span>
<span class="line"><span class="token keyword">const</span> LineItem <span class="token operator">=</span> <span class="token function">valueObject</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;LineItem&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">schema</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">productId</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">productName</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">quantity</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">unitPrice</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">getSubtotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>quantity <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>unitPrice<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Define an Order aggregate</span></span>
<span class="line"><span class="token keyword">const</span> Order <span class="token operator">=</span> <span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Order&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">schema</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">customerId</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">items</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>LineItem<span class="token punctuation">.</span>schema<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">status</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">enum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;DRAFT&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PAID&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;SHIPPED&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;DELIVERED&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;CANCELLED&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">shippingAddress</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">street</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">city</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">state</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">zipCode</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">country</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">placedAt</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">identity</span><span class="token operator">:</span> <span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">invariants</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Order must have items when placed&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function-variable function">check</span><span class="token operator">:</span> <span class="token parameter">order</span> <span class="token operator">=&gt;</span> order<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">&#39;PLACED&#39;</span> <span class="token operator">||</span> order<span class="token punctuation">.</span>items<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;Cannot place an empty order&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Placed order must have shipping address&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function-variable function">check</span><span class="token operator">:</span> <span class="token parameter">order</span> <span class="token operator">=&gt;</span> order<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">&#39;PLACED&#39;</span> <span class="token operator">||</span> order<span class="token punctuation">.</span>shippingAddress <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;Shipping address is required to place an order&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Placed order must have placedAt timestamp&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function-variable function">check</span><span class="token operator">:</span> <span class="token parameter">order</span> <span class="token operator">=&gt;</span> order<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">&#39;PLACED&#39;</span> <span class="token operator">||</span> order<span class="token punctuation">.</span>placedAt <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;Missing placement timestamp&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Add a product to the order</span></span>
<span class="line">    <span class="token function">addItem</span><span class="token punctuation">(</span><span class="token parameter">product<span class="token punctuation">,</span> quantity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// Reject modifications to orders that aren&#39;t in draft status</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">&#39;DRAFT&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot add items to an order with status: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token comment">// Create a new line item</span></span>
<span class="line">      <span class="token keyword">const</span> newItem <span class="token operator">=</span> LineItem<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">productId</span><span class="token operator">:</span> product<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">productName</span><span class="token operator">:</span> product<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span>
<span class="line">        quantity<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">unitPrice</span><span class="token operator">:</span> product<span class="token punctuation">.</span>price</span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      </span>
<span class="line">      <span class="token comment">// Check if the product already exists in the order</span></span>
<span class="line">      <span class="token keyword">const</span> existingItemIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> </span>
<span class="line">        item<span class="token punctuation">.</span>productId <span class="token operator">===</span> product<span class="token punctuation">.</span>id</span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">let</span> updatedItems<span class="token punctuation">;</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingItemIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Update the quantity if the product already exists</span></span>
<span class="line">        <span class="token keyword">const</span> existingItem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">[</span>existingItemIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">const</span> updatedItem <span class="token operator">=</span> LineItem<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">          <span class="token operator">...</span>existingItem<span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">quantity</span><span class="token operator">:</span> existingItem<span class="token punctuation">.</span>quantity <span class="token operator">+</span> quantity</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        updatedItems <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">          <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> existingItemIndex<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">          updatedItem<span class="token punctuation">,</span></span>
<span class="line">          <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>existingItemIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Add a new item if the product doesn&#39;t exist in the order</span></span>
<span class="line">        updatedItems <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">,</span> newItem<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token comment">// Return a new Order instance with the updated items</span></span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">items</span><span class="token operator">:</span> updatedItems<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Remove an item from the order</span></span>
<span class="line">    <span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token parameter">productId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">&#39;DRAFT&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot remove items from an order with status: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">const</span> updatedItems <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> </span>
<span class="line">        item<span class="token punctuation">.</span>productId <span class="token operator">!==</span> productId</span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      </span>
<span class="line">      <span class="token comment">// If nothing was removed, throw an error</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span>updatedItems<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Product </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>productId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found in order</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">items</span><span class="token operator">:</span> updatedItems<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Place the order</span></span>
<span class="line">    <span class="token function">placeOrder</span><span class="token punctuation">(</span><span class="token parameter">shippingAddress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">&#39;DRAFT&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot place an order with status: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token comment">// Note: The invariants will automatically check if the order has items</span></span>
<span class="line">      <span class="token comment">// and if the shipping address is provided</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        shippingAddress<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">placedAt</span><span class="token operator">:</span> now<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> now</span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emitEvent</span><span class="token punctuation">(</span><span class="token string">&#39;OrderPlaced&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">orderId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">customerId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>customerId<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">placedAt</span><span class="token operator">:</span> now</span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Cancel the order</span></span>
<span class="line">    <span class="token function">cancelOrder</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token string">&#39;DRAFT&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PAID&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot cancel an order with status: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;CANCELLED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emitEvent</span><span class="token punctuation">(</span><span class="token string">&#39;OrderCancelled&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">orderId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">reason</span><span class="token operator">:</span> reason <span class="token operator">||</span> <span class="token string">&#39;Customer requested cancellation&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">cancelledAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Calculate the total cost of the order</span></span>
<span class="line">    <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token punctuation">(</span><span class="token parameter">total<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> total <span class="token operator">+</span> LineItem<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSubtotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">        <span class="token number">0</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="reviewing-the-components" tabindex="-1"><a class="header-anchor" href="#reviewing-the-components"><span>Reviewing the Components</span></a></h3><p>Let&#39;s break down the key elements:</p><ol><li><strong>schema</strong>: Defines the structure and validation rules for the aggregate</li><li><strong>identity</strong>: Specifies which property serves as the identity of the aggregate root</li><li><strong>invariants</strong>: Business rules that must always be true for the aggregate to be valid</li><li><strong>methods</strong>: Operations that modify the aggregate or provide information about it</li></ol><h2 id="determining-aggregate-boundaries" tabindex="-1"><a class="header-anchor" href="#determining-aggregate-boundaries"><span>Determining Aggregate Boundaries</span></a></h2><p>One of the most challenging aspects of using aggregates is deciding what should be included within a single aggregate boundary. This decision impacts both consistency and performance.</p><h3 id="guidelines-for-good-aggregate-design" tabindex="-1"><a class="header-anchor" href="#guidelines-for-good-aggregate-design"><span>Guidelines for Good Aggregate Design</span></a></h3><ol><li><strong>Include only what must be consistent together</strong> - If two things must be consistent with each other, they likely belong in the same aggregate</li><li><strong>Keep aggregates small</strong> - Smaller aggregates are easier to load, save, and keep consistent</li><li><strong>Consider domain experts&#39; mental model</strong> - How domain experts think about related concepts often hints at natural aggregate boundaries</li><li><strong>Analyze transactional requirements</strong> - What needs to change together in a single transaction?</li><li><strong>Consider performance implications</strong> - Very large aggregates can cause performance issues</li></ol><h3 id="common-aggregate-patterns" tabindex="-1"><a class="header-anchor" href="#common-aggregate-patterns"><span>Common Aggregate Patterns</span></a></h3><p>Here are some common patterns for aggregates across different domains:</p><table><thead><tr><th>Domain</th><th>Aggregate Root</th><th>Contains</th></tr></thead><tbody><tr><td>E-commerce</td><td>Order</td><td>OrderLines, ShippingInfo, PaymentDetails</td></tr><tr><td>Banking</td><td>Account</td><td>Transactions, AccountHolders, AccountRules</td></tr><tr><td>HR</td><td>Employee</td><td>Positions, Skills, Benefits, TimeEntries</td></tr><tr><td>Inventory</td><td>Product</td><td>Variants, Specifications, StockLevels</td></tr><tr><td>Insurance</td><td>Policy</td><td>Coverage, Claims, Beneficiaries</td></tr></tbody></table><h3 id="example-e-commerce-domain" tabindex="-1"><a class="header-anchor" href="#example-e-commerce-domain"><span>Example: E-commerce Domain</span></a></h3><p>In an e-commerce system, you might have these aggregates:</p><ul><li><p><strong>Order Aggregate</strong></p><ul><li>Root: Order</li><li>Contains: OrderLines, ShippingDetails, BillingDetails</li></ul></li><li><p><strong>Product Aggregate</strong></p><ul><li>Root: Product</li><li>Contains: ProductVariants, ProductAttributes, Pricing</li></ul></li><li><p><strong>Customer Aggregate</strong></p><ul><li>Root: Customer</li><li>Contains: CustomerAddresses, PaymentMethods, Preferences</li></ul></li><li><p><strong>ShoppingCart Aggregate</strong></p><ul><li>Root: ShoppingCart</li><li>Contains: CartItems, AppliedDiscounts, ShippingEstimate</li></ul></li></ul><p>Note that each aggregate references others by ID, not direct object references.</p><h2 id="using-aggregates" tabindex="-1"><a class="header-anchor" href="#using-aggregates"><span>Using Aggregates</span></a></h2><p>Once you&#39;ve defined your aggregates, you can use them in your application:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// Create a new order</span></span>
<span class="line"><span class="token keyword">let</span> order <span class="token operator">=</span> Order<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;123e4567-e89b-12d3-a456-426614174000&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">customerId</span><span class="token operator">:</span> <span class="token string">&#39;123e4567-e89b-12d3-a456-426614174001&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;DRAFT&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Add items to the order</span></span>
<span class="line"><span class="token keyword">const</span> keyboard <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;123e4567-e89b-12d3-a456-426614174002&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Mechanical Keyboard&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">price</span><span class="token operator">:</span> <span class="token number">89.99</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> mouse <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;123e4567-e89b-12d3-a456-426614174003&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Ergonomic Mouse&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">price</span><span class="token operator">:</span> <span class="token number">59.99</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">order <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">addItem</span><span class="token punctuation">(</span>keyboard<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">order <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">addItem</span><span class="token punctuation">(</span>mouse<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Calculate the total</span></span>
<span class="line"><span class="token keyword">const</span> total <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 149.98</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Place the order</span></span>
<span class="line"><span class="token keyword">const</span> shippingAddress <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">street</span><span class="token operator">:</span> <span class="token string">&#39;123 Main St&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">&#39;Anytown&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token string">&#39;CA&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">zipCode</span><span class="token operator">:</span> <span class="token string">&#39;12345&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">country</span><span class="token operator">:</span> <span class="token string">&#39;US&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">order <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">placeOrder</span><span class="token punctuation">(</span>shippingAddress<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Order is now in PLACED status and has emitted an OrderPlaced event</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#39;PLACED&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="immutability-and-state-changes" tabindex="-1"><a class="header-anchor" href="#immutability-and-state-changes"><span>Immutability and State Changes</span></a></h3><p>Like entities in DomainDrivenJS, aggregates are immutable. State changes create new instances:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> draftOrder <span class="token operator">=</span> Order<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>draftOrder<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#39;DRAFT&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> placedOrder <span class="token operator">=</span> draftOrder<span class="token punctuation">.</span><span class="token function">placeOrder</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>placedOrder<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &#39;PLACED&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// The original order remains unchanged</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>draftOrder<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Still &#39;DRAFT&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="invariants-protecting-business-rules" tabindex="-1"><a class="header-anchor" href="#invariants-protecting-business-rules"><span>Invariants: Protecting Business Rules</span></a></h2><p>Invariants are business rules that must always be satisfied within an aggregate. They&#39;re checked whenever an aggregate is created or updated:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> Order <span class="token operator">=</span> <span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ... other properties ...</span></span>
<span class="line">  <span class="token literal-property property">invariants</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Order must have items when placed&#39;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token function-variable function">check</span><span class="token operator">:</span> <span class="token parameter">order</span> <span class="token operator">=&gt;</span> order<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">&#39;PLACED&#39;</span> <span class="token operator">||</span> order<span class="token punctuation">.</span>items<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">&quot;Cannot place an empty order&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// This will throw an InvariantViolationError because it violates the invariant</span></span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> emptyOrder <span class="token operator">=</span> Order<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">customerId</span><span class="token operator">:</span> <span class="token string">&#39;456&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// Empty items array</span></span>
<span class="line">    <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">,</span> <span class="token comment">// Status is PLACED, which requires items</span></span>
<span class="line">    <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// &quot;InvariantViolationError: Cannot place an empty order&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="invariants-vs-validation" tabindex="-1"><a class="header-anchor" href="#invariants-vs-validation"><span>Invariants vs. Validation</span></a></h3><p>It&#39;s important to understand the difference between validation and invariants:</p><ul><li><strong>Validation</strong> checks if individual values are valid (handled by the Zod schema)</li><li><strong>Invariants</strong> check if the relationships between values make sense in the business context</li></ul><p>For example:</p><ul><li>Validation ensures a price is a positive number</li><li>An invariant ensures that an order can&#39;t be placed without items</li></ul><h2 id="domain-events" tabindex="-1"><a class="header-anchor" href="#domain-events"><span>Domain Events</span></a></h2><p>Aggregates are the natural place for generating domain events - significant occurrences that other parts of the system might want to know about:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> Order <span class="token operator">=</span> <span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ... previous properties ...</span></span>
<span class="line">  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">placeOrder</span><span class="token punctuation">(</span><span class="token parameter">shippingAddress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">&#39;DRAFT&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot place an order with status: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        shippingAddress<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">placedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emitEvent</span><span class="token punctuation">(</span><span class="token string">&#39;OrderPlaced&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">orderId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">customerId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>customerId<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">total</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">placedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">markAsShipped</span><span class="token punctuation">(</span><span class="token parameter">trackingNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">&#39;PAID&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot ship an order with status: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;SHIPPED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        trackingNumber<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">emitEvent</span><span class="token punctuation">(</span><span class="token string">&#39;OrderShipped&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">orderId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">        trackingNumber<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">shippedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="working-with-events" tabindex="-1"><a class="header-anchor" href="#working-with-events"><span>Working with Events</span></a></h3><p>Events emitted by aggregates are typically handled when the aggregate is saved to a repository:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// When saving with a repository, events are published to subscribers</span></span>
<span class="line"><span class="token keyword">await</span> orderRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">placeOrder</span><span class="token punctuation">(</span>shippingAddress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Event handlers respond to the events</span></span>
<span class="line">eventBus<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#39;OrderPlaced&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Order </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>orderId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> was placed with total </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>total<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// Handle the event by performing related actions</span></span>
<span class="line">  <span class="token keyword">await</span> notificationService<span class="token punctuation">.</span><span class="token function">sendOrderConfirmation</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>customerId<span class="token punctuation">,</span> event<span class="token punctuation">.</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">await</span> inventoryService<span class="token punctuation">.</span><span class="token function">reserveItems</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="inter-aggregate-references" tabindex="-1"><a class="header-anchor" href="#inter-aggregate-references"><span>Inter-Aggregate References</span></a></h2><p>A critical rule of aggregates is that they should reference other aggregates by identity, not by direct object reference. This maintains proper boundaries and prevents tangled object graphs:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// BAD: Direct reference to another aggregate</span></span>
<span class="line"><span class="token keyword">const</span> Order <span class="token operator">=</span> <span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Order&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">schema</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">customer</span><span class="token operator">:</span> Customer<span class="token punctuation">.</span>schema<span class="token punctuation">,</span> <span class="token comment">// Direct reference to Customer aggregate</span></span>
<span class="line">    <span class="token comment">// ... other fields</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// GOOD: Reference by identity</span></span>
<span class="line"><span class="token keyword">const</span> Order <span class="token operator">=</span> <span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Order&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">schema</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">customerId</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Reference by ID</span></span>
<span class="line">    <span class="token comment">// ... other fields</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="why-this-matters" tabindex="-1"><a class="header-anchor" href="#why-this-matters"><span>Why This Matters</span></a></h3><p>Referencing by identity provides several benefits:</p><ol><li><strong>Clear boundaries</strong> - It&#39;s obvious where one aggregate ends and another begins</li><li><strong>Simpler persistence</strong> - Easier to save aggregates independently</li><li><strong>Reduced memory usage</strong> - Don&#39;t need to load entire object graphs</li><li><strong>Consistency control</strong> - Changes to one aggregate don&#39;t directly affect others</li><li><strong>Easier concurrency handling</strong> - Less chance of conflicting changes</li></ol><h2 id="aggregate-repositories" tabindex="-1"><a class="header-anchor" href="#aggregate-repositories"><span>Aggregate Repositories</span></a></h2><p>Each aggregate type should have its own repository for persistence:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;domaindrivenjs&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> OrderRepository <span class="token operator">=</span> <span class="token function">repository</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">aggregate</span><span class="token operator">:</span> Order<span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">mongoAdapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">connectionString</span><span class="token operator">:</span> <span class="token string">&#39;mongodb://localhost:27017&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;shop&#39;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">collection</span><span class="token operator">:</span> <span class="token string">&#39;orders&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">// Configuration for event handling</span></span>
<span class="line">  <span class="token literal-property property">events</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">publishOnSave</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// Publish events when saving</span></span>
<span class="line">    <span class="token literal-property property">clearAfterPublish</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// Clear events after publishing</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Custom queries</span></span>
<span class="line"><span class="token keyword">const</span> OrderRepository <span class="token operator">=</span> <span class="token function">repository</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">aggregate</span><span class="token operator">:</span> Order<span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">mongoAdapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">collectionName</span><span class="token operator">:</span> <span class="token string">&quot;orders&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">findByCustomerId</span><span class="token punctuation">(</span><span class="token parameter">customerId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findMany</span><span class="token punctuation">(</span><span class="token punctuation">{</span> customerId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">findPendingOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findMany</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token punctuation">{</span> $<span class="token keyword">in</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PAID&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Using the repository</span></span>
<span class="line"><span class="token keyword">const</span> orderRepo <span class="token operator">=</span> OrderRepository<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MongoAdapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">connectionString</span><span class="token operator">:</span> <span class="token string">&#39;mongodb://localhost:27017&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">&#39;shop&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">collection</span><span class="token operator">:</span> <span class="token string">&#39;orders&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Save an order and publish its events</span></span>
<span class="line"><span class="token keyword">await</span> orderRepo<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Find an order by ID</span></span>
<span class="line"><span class="token keyword">const</span> savedOrder <span class="token operator">=</span> <span class="token keyword">await</span> orderRepo<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Find all orders for a customer</span></span>
<span class="line"><span class="token keyword">const</span> customerOrders <span class="token operator">=</span> <span class="token keyword">await</span> orderRepo<span class="token punctuation">.</span><span class="token function">findByCustomerId</span><span class="token punctuation">(</span>customerId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="advanced-aggregate-patterns" tabindex="-1"><a class="header-anchor" href="#advanced-aggregate-patterns"><span>Advanced Aggregate Patterns</span></a></h2><h3 id="handling-large-aggregates" tabindex="-1"><a class="header-anchor" href="#handling-large-aggregates"><span>Handling Large Aggregates</span></a></h3><p>For aggregates with a lot of data, you might want to use lazy loading for certain parts:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> Order <span class="token operator">=</span> <span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Order&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">schema</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">customerId</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">summary</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">itemCount</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nonnegative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">total</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nonnegative</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// These fields might be lazily loaded</span></span>
<span class="line">    <span class="token literal-property property">items</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>LineItem<span class="token punctuation">.</span>schema<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">history</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>OrderHistoryEntry<span class="token punctuation">.</span>schema<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Method to load full details when needed</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token function">loadFullDetails</span><span class="token punctuation">(</span><span class="token parameter">orderRepository</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// Already loaded</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">await</span> orderRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token punctuation">{</span> </span>
<span class="line">        <span class="token literal-property property">includeItems</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">includeHistory</span><span class="token operator">:</span> <span class="token boolean">true</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="nested-entities" tabindex="-1"><a class="header-anchor" href="#nested-entities"><span>Nested Entities</span></a></h3><p>Sometimes you need entities inside an aggregate that aren&#39;t aggregates themselves:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// A nested entity inside the Order aggregate</span></span>
<span class="line"><span class="token keyword">const</span> OrderItem <span class="token operator">=</span> <span class="token function">entity</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;OrderItem&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">schema</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">productId</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">productName</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">quantity</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">unitPrice</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">options</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">name</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">value</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">identity</span><span class="token operator">:</span> <span class="token string">&#39;id&#39;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> Order <span class="token operator">=</span> <span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Order&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">schema</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">customerId</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">items</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>OrderItem<span class="token punctuation">.</span>schema<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// ... other fields</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">// ... rest of the aggregate</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="state-transitions" tabindex="-1"><a class="header-anchor" href="#state-transitions"><span>State Transitions</span></a></h3><p>For aggregates with complex lifecycle states, explicitly modeling state transitions can be helpful:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token keyword">const</span> Order <span class="token operator">=</span> <span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;Order&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">schema</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">id</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">customerId</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">status</span><span class="token operator">:</span> z<span class="token punctuation">.</span><span class="token function">enum</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;DRAFT&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PAID&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;SHIPPED&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;DELIVERED&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;CANCELLED&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token comment">// ... other fields</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// State transitions</span></span>
<span class="line">    <span class="token function">place</span><span class="token punctuation">(</span><span class="token parameter">shippingAddress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assertStatus</span><span class="token punctuation">(</span><span class="token string">&#39;DRAFT&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        shippingAddress<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">placedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">markAsPaid</span><span class="token punctuation">(</span><span class="token parameter">paymentId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assertStatus</span><span class="token punctuation">(</span><span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;PAID&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        paymentId<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">paidAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">ship</span><span class="token punctuation">(</span><span class="token parameter">trackingNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assertStatus</span><span class="token punctuation">(</span><span class="token string">&#39;PAID&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;SHIPPED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        trackingNumber<span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">shippedAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">deliver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assertStatus</span><span class="token punctuation">(</span><span class="token string">&#39;SHIPPED&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;DELIVERED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">deliveredAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assertStatusIn</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;DRAFT&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PAID&#39;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> Order<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;CANCELLED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token literal-property property">cancelledAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// Helper method for state validation</span></span>
<span class="line">    <span class="token function">assertStatus</span><span class="token punctuation">(</span><span class="token parameter">expected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> expected<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Order must be in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expected<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> status, but was </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    </span>
<span class="line">    <span class="token function">assertStatusIn</span><span class="token punctuation">(</span><span class="token parameter">expectedStatuses</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expectedStatuses<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Order must be in one of [</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expectedStatuses<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;, &#39;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] statuses, but was </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="event-sourcing" tabindex="-1"><a class="header-anchor" href="#event-sourcing"><span>Event Sourcing</span></a></h3><p>For more advanced scenarios, you can implement event sourcing with aggregates, where the state is reconstructed from a sequence of events:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code><span class="line"><span class="token comment">// Simplified event sourcing example</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">applyEvents</span><span class="token punctuation">(</span><span class="token parameter">events<span class="token punctuation">,</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// Rebuild aggregate state by applying events in sequence</span></span>
<span class="line">  <span class="token keyword">return</span> events<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">case</span> <span class="token string">&#39;OrderCreated&#39;</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token literal-property property">id</span><span class="token operator">:</span> event<span class="token punctuation">.</span>orderId<span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">customerId</span><span class="token operator">:</span> event<span class="token punctuation">.</span>customerId<span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;DRAFT&#39;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">case</span> <span class="token string">&#39;OrderItemAdded&#39;</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token operator">...</span>state<span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>state<span class="token punctuation">.</span>items<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token literal-property property">productId</span><span class="token operator">:</span> event<span class="token punctuation">.</span>productId<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">productName</span><span class="token operator">:</span> event<span class="token punctuation">.</span>productName<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">quantity</span><span class="token operator">:</span> event<span class="token punctuation">.</span>quantity<span class="token punctuation">,</span></span>
<span class="line">            <span class="token literal-property property">unitPrice</span><span class="token operator">:</span> event<span class="token punctuation">.</span>unitPrice</span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">case</span> <span class="token string">&#39;OrderPlaced&#39;</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token operator">...</span>state<span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">&#39;PLACED&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token literal-property property">placedAt</span><span class="token operator">:</span> event<span class="token punctuation">.</span>timestamp</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">      </span>
<span class="line">      <span class="token comment">// Handle other events...</span></span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">        <span class="token keyword">return</span> state<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> initialState<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Recreate order from events</span></span>
<span class="line"><span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token keyword">await</span> eventStore<span class="token punctuation">.</span><span class="token function">getEvents</span><span class="token punctuation">(</span><span class="token string">&#39;order-123&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> order <span class="token operator">=</span> Order<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token function">applyEvents</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="best-practices" tabindex="-1"><a class="header-anchor" href="#best-practices"><span>Best Practices</span></a></h2><ol><li><strong>Keep aggregates small</strong> - Focus on true invariants, not just related data</li><li><strong>Reference other aggregates by ID</strong> - Don&#39;t create direct object references between aggregates</li><li><strong>Design for eventual consistency</strong> - Between aggregates, use eventual consistency, not immediate consistency</li><li><strong>Choose the right aggregate root</strong> - The root should be the natural entry point and enforce all invariants</li><li><strong>Name aggregates as nouns</strong> - Use domain terminology from your ubiquitous language</li><li><strong>Test aggregate invariants</strong> - Write tests that verify your business rules are enforced</li><li><strong>Use domain events</strong> - Emit events when significant state changes occur</li><li><strong>Transaction per aggregate</strong> - Modify only one aggregate per transaction</li><li><strong>Be mindful of loading performance</strong> - Consider how aggregates will be loaded and used</li><li><strong>Model state transitions explicitly</strong> - Make lifecycle states and transitions clear</li></ol><h2 id="common-aggregate-examples" tabindex="-1"><a class="header-anchor" href="#common-aggregate-examples"><span>Common Aggregate Examples</span></a></h2><p>Here are some common aggregate examples from different domains to inspire your own modeling:</p><h3 id="e-commerce" tabindex="-1"><a class="header-anchor" href="#e-commerce"><span>E-commerce</span></a></h3><ul><li><strong>Order</strong> (root) with OrderItems, ShippingInfo</li><li><strong>Product</strong> (root) with Variants, Attributes, Images</li><li><strong>Inventory</strong> (root) with StockItems, Reservations</li><li><strong>Customer</strong> (root) with Addresses, PaymentMethods</li></ul><h3 id="banking" tabindex="-1"><a class="header-anchor" href="#banking"><span>Banking</span></a></h3><ul><li><strong>Account</strong> (root) with Transactions, AccountHolders</li><li><strong>Loan</strong> (root) with PaymentSchedule, CollateralItems</li><li><strong>Transfer</strong> (root) with SourceAccount, DestinationAccount, Amount</li></ul><h3 id="project-management" tabindex="-1"><a class="header-anchor" href="#project-management"><span>Project Management</span></a></h3><ul><li><strong>Project</strong> (root) with Tasks, Members, Milestones</li><li><strong>Task</strong> (root) with Comments, Attachments, TimeEntries</li><li><strong>Team</strong> (root) with Members, Roles, Permissions</li></ul><h2 id="troubleshooting-common-issues" tabindex="-1"><a class="header-anchor" href="#troubleshooting-common-issues"><span>Troubleshooting Common Issues</span></a></h2><h3 id="my-aggregates-are-too-large" tabindex="-1"><a class="header-anchor" href="#my-aggregates-are-too-large"><span>&quot;My aggregates are too large&quot;</span></a></h3><p><strong>Signs</strong>:</p><ul><li>Slow loading times</li><li>Complex relationships inside the aggregate</li><li>Too many items in collections</li></ul><p><strong>Solutions</strong>:</p><ul><li>Split into multiple aggregates with references by ID</li><li>Use summary data instead of embedding full objects</li><li>Implement lazy loading for less-frequently-needed data</li></ul><h3 id="changes-to-one-aggregate-affect-another" tabindex="-1"><a class="header-anchor" href="#changes-to-one-aggregate-affect-another"><span>&quot;Changes to one aggregate affect another&quot;</span></a></h3><p><strong>Signs</strong>:</p><ul><li>Invariants span multiple aggregates</li><li>Direct references between aggregates</li><li>Changes don&#39;t save correctly</li></ul><p><strong>Solutions</strong>:</p><ul><li>Use domain events to maintain eventual consistency</li><li>Reference by ID, not by object reference</li><li>Reconsider your aggregate boundaries</li></ul><h3 id="it-s-hard-to-decide-what-belongs-together" tabindex="-1"><a class="header-anchor" href="#it-s-hard-to-decide-what-belongs-together"><span>&quot;It&#39;s hard to decide what belongs together&quot;</span></a></h3><p><strong>Signs</strong>:</p><ul><li>Uncertainty about which objects belong in which aggregate</li><li>Frequent changes to aggregate structure</li></ul><p><strong>Solutions</strong>:</p><ul><li>Focus on what must be consistent together</li><li>Look at transaction boundaries in the business</li><li>Consider performance implications</li><li>Start broader and refine later</li></ul><h2 id="next-steps" tabindex="-1"><a class="header-anchor" href="#next-steps"><span>Next Steps</span></a></h2><p>Now that you understand aggregates, explore these related topics:</p><ul><li><a class="route-link" href="/domaindrivenjs/guide/core/repositories.html">Repositories</a> - For persisting and retrieving aggregates</li><li><a class="route-link" href="/domaindrivenjs/guide/core/domain-events.html">Domain Events</a> - For communication between aggregates</li><li><a class="route-link" href="/domaindrivenjs/guide/core/specifications.html">Specifications</a> - For encapsulating query logic</li><li><a class="route-link" href="/domaindrivenjs/guide/core/domain-services.html">Domain Services</a> - For operations that span multiple aggregates</li></ul></div><!--[--><!--]--></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link label" href="https://github.com/MarcoMuellner/DomainDrivenJS/edit/main/docs/guide/core/aggregates.md" aria-label="Help us improve this page!" rel="noopener noreferrer" target="_blank"><!--[--><!--[--><svg class="edit-icon" viewbox="0 0 1024 1024"><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]--><!--]-->Help us improve this page!<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated:: </span><time class="meta-item-info" datetime="2025-04-17T18:38:14.000Z" data-allow-mismatch>4/17/25, 6:38 PM</time></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: muellnermarco@gmail.com">Marco Müllner</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/domaindrivenjs/guide/core/entities.html" aria-label="Working with Entities"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span class="external-link">Working with Entities</span></div><!--]--></a><a class="route-link auto-link next" href="/domaindrivenjs/guide/core/repositories.html" aria-label="Working with Repositories"><!--[--><div class="hint">Next <span class="arrow right"></span></div><div class="link"><span class="external-link">Working with Repositories</span></div><!--]--></a></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/domaindrivenjs/assets/app-BR1hGEJk.js" defer></script>
  </body>
</html>
